
    const translations = {
  "geo": {
    "hero": {
      "eyebrow": "NEXT CHAPTER | ცამეტი",
      "title": "Fractal Events",
      "copy": "Animato ბრუნდება Tsameti-ში UV დეკორაციებით, SHALA ირანიდან და განახლებული ქართული სცენის ენერგიით.",
      "primary": "ბილეთების დაჯავშნა",
      "secondary": "დეტალები"
    },
    "stats": [
      {
        "value": "23+",
        "label": "Face Control"
      },
      {
        "value": "6",
        "label": "არტისტი სცენაზე"
      },
      {
        "value": "22:00",
        "label": "დაწყება"
      }
    ],
    "slider": [
      {
        "title": "ANIMATO - NEXT CHAPTER",
        "tag": "ჰედლაინერი",
        "copy": "მზად ხარ ახალი ფსიქოდელიური თავგადასავლისთვის? 28 ნოემბერს Fractal ცამეტის სცენას აანთებს Animato-ს, SHALA-ს და განახლებულ ადგილობრივ გუნდთან ერთად.",
        "meta": "28 ნოემბერი | Tsameti Restaurant | თბილისი",
        "image": "Poster28.webp",
        "accent": "#7affc6"
      }
    ],
    "eventSection": {
      "eyebrow": "სცენის პულსი",
      "heading": "ANIMATO - NEXT CHAPTER",
      "blurb": "ლოკალური ბილეთები, ქართული არტისტები, გლობალური ხარისხის პროდაქშენი."
    },
    "events": [
      {
        "title": "ANIMATO - NEXT CHAPTER TBILISI",
        "date": "28 ნოემბერი 2024 | პარასკევი",
        "city": "Tsameti Restaurant, თამარაშვილის 13e, თბილისი",
        "price": "I კალათა: 60 ₾ | II კალათა: 80 ₾ | კარზე: 120 ₾",
        "vibe": "თბილისის ჰედლაინერი",
        "capacity": "Face Control 23+",
        "description": "NEXT CHAPTER — 28 ნოემბერს Fractal უფრო მეტი მუხტით და განახლებული ენერგიით ბრუნდება და ცამეტის სცენაზე იწვევს ფსაიტრანსის წამყვან ვარსკვლავ Animato-ს. მასთან ერთად ჰიპნოზურ სეტს უკრავს SHALA ირანიდან და ქართველი არტისტების ძლიერი შემადგენლობა. ბასი, ლაზერები და UV ინსტალაციები ქმნის უწყვეტ ღამეს.",
        "accent": "#7affc6",
        "poster": "Poster28.webp",
        "lineup": [
          "ANIMATO",
          "SHALA",
          "MARCUSS",
          "INFEST",
          "HOLO",
          "NAKAMURA"
        ],
        "rituals": [
          "ახალი UV დეკორაციები და ინტერაქტიული ინსტალაციები",
          "ლაზერები და პროექციის მეფინგი, ძლიერი ბასი",
          "ჩილ და საგამოფენო ზონა",
          "სახის/სხეულის UV მოხატვა"
        ],
        "timeline": [
          {
            "label": "თარიღი",
            "value": "28 ნოემბერი",
            "copy": "პარასკევი | 22:00+"
          },
          {
            "label": "Face Control",
            "value": "23+",
            "copy": "Dress code: ფსაი/ტრაიბალ"
          },
          {
            "label": "ბილეთები",
            "value": "60/80/120 ₾",
            "copy": "I | II | კარზე"
          },
          {
            "label": "ლოკაცია",
            "value": "Tsameti",
            "copy": "თამარაშვილის 13e"
          }
        ],
        "blurb": "პარასკევი, 28 ნოემბერი | 22:00+ | Tsameti Restaurant, თბილისი"
      }
    ],
    "perks": [
      "ახალი UV დეკორაციები და ინტერაქტიული ინსტალაციები",
      "ლაზერები, მეფინგი და ძლიერი ბასი",
      "ჩილ + საგამოფენო ზონა და UV face/body art"
    ],
    "booking": {
      "eyebrow": "დაჯავშნა",
      "focus": "ANIMATO - NEXT CHAPTER TBILISI",
      "copy": "პარასკევი, 28 ნოემბერი | 22:00+ | Tsameti Restaurant, თამარაშვილის 13e, თბილისი",
      "placeholderEvent": "აირჩიე ღონისძიება",
      "namePlaceholder": "მაგ. ნიკა მოსულიშვილი",
      "phonePlaceholder": "+995 5XX XX XX XX",
      "paymentPlaceholder": "აირჩიე გადახდის მეთოდი"
    },
    "form": {
      "labels": {
        "event": "ღონისძიება",
        "name": "სრული სახელი",
        "email": "ელ.ფოსტა",
        "phone": "ტელეფონი",
        "guests": "სტუმრები",
        "tier": "ბილეთის კატეგორია",
        "payment": "გადახდა",
        "paymentId": "ბარათი / საფულის ID"
      },
      "tiers": [
        { "value": "tier1", "label": "I კალათა" },
        { "value": "tier2", "label": "II კალათა" },
        { "value": "door", "label": "კარზე" }
      ],
      "payments": [
        {
          "value": "",
          "label": "აირჩიე გადახდა",
          "disabled": true
        },
        { "value": "card", "label": "ბარათი" },
        { "value": "transfer-tbc", "label": "ბანკი (TBC)" },
        { "value": "transfer-bog", "label": "ბანკი (Georgian Bank)" },
        { "value": "crypto", "label": "კრიპტო" },
        { "value": "apple", "label": "Apple Pay" }
      ],
      "submit": "დადასტურება",
      "download": "Excel ჩამოტვირთვა"
    },
    "confirm": {
      "missingEvent": "გთხოვ, აირჩიე ღონისძიება.",
      "success": (name, tier, eventTitle) => `${name}, შენი ${tier} ბილეთი ${eventTitle}-ზე დადასტურებულია.`,
      "excel": "Excel ფაილი განახლდა."
    }
  },
  "eng": {
    "hero": {
      "eyebrow": "Next Chapter | Tbilisi",
      "title": "Fractal Events",
      "copy": "Animato returns to Tsameti with UV decor, SHALA from Iran, and a reborn Georgian squad.",
      "primary": "Book Tickets",
      "secondary": "See Details"
    },
    "stats": [
      {
        "value": "23+",
        "label": "Face Control"
      },
      {
        "value": "6",
        "label": "Artists On Deck"
      },
      {
        "value": "22:00",
        "label": "Launch Time"
      }
    ],
    "slider": [
      {
        "title": "ANIMATO - NEXT CHAPTER",
        "tag": "Headliner portal",
        "copy": "Ready for a new psychedelic quest? On 28 Nov, Fractal reignites Tsameti with Animato, SHALA, and a recharged local crew.",
        "meta": "28 Nov | Tsameti Restaurant | Tbilisi",
        "image": "Poster28.webp",
        "accent": "#7affc6"
      }
    ],
    "eventSection": {
      "eyebrow": "Scene Pulse",
      "heading": "ANIMATO - NEXT CHAPTER",
      "blurb": "Local tickets, local artists, global-grade production."
    },
    "events": [
      {
        "title": "ANIMATO - NEXT CHAPTER TBILISI",
        "date": "28 November 2024 | Friday",
        "city": "Tsameti Restaurant, 13e Mikheil Tamarashvili St, Tbilisi",
        "price": "Wave I: 60 ₾ | Wave II: 80 ₾ | Door: 120 ₾",
        "vibe": "Tbilisi headliner",
        "capacity": "Face Control 23+",
        "description": "Animato, SHALA, and elite Georgian selectors deliver lasers, UV art, and heavy bass for a nonstop night.",
        "accent": "#7affc6",
        "poster": "Poster28.webp",
        "lineup": [
          "ANIMATO",
          "SHALA",
          "MARCUSS",
          "INFEST",
          "HOLO",
          "NAKAMURA"
        ],
        "rituals": [
          "Next-gen UV decor and interactive installations",
          "Lasers and projection mapping with heavy bass",
          "Chill and exhibit lounge",
          "UV face/body art corners"
        ],
        "timeline": [
          {
            "label": "Date",
            "value": "28 Nov",
            "copy": "Friday | 22:00+"
          },
          {
            "label": "Face Control",
            "value": "23+",
            "copy": "Dress code: Psy/Tribal"
          },
          {
            "label": "Tickets",
            "value": "60/80/120 ₾",
            "copy": "Wave I | Wave II | Door"
          },
          {
            "label": "Venue",
            "value": "Tsameti",
            "copy": "13e Mikheil Tamarashvili St"
          }
        ],
        "blurb": "Friday, 28 Nov | 22:00+ | Tsameti Restaurant, Tbilisi"
      }
    ],
    "perks": [
      "Next-gen UV decor & interactive installations",
      "Lasers, mapping, and earth-shaking bass",
      "Chill + exhibit zones with UV face/body art"
    ],
    "booking": {
      "eyebrow": "Reserve your passage",
      "focus": "ANIMATO - NEXT CHAPTER TBILISI",
      "copy": "Friday, 28 Nov | 22:00+ | Tsameti Restaurant, 13e Mikheil Tamarashvili St, Tbilisi",
      "placeholderEvent": "Tap an event card",
      "namePlaceholder": "e.g. Nova Traveler",
      "phonePlaceholder": "+995 5XX XX XX XX",
      "paymentPlaceholder": "Choose a method"
    },
    "form": {
      "labels": {
        "event": "Event",
        "name": "Full name",
        "email": "Email address",
        "phone": "Phone",
        "guests": "Guests",
        "tier": "Ticket tier",
        "payment": "Payment method",
        "paymentId": "Card / Wallet ID"
      },
      "tiers": [
        {
          "value": "tier1",
          "label": "Wave I"
        },
        {
          "value": "tier2",
          "label": "Wave II"
        },
        {
          "value": "door",
          "label": "Door"
        }
      ],
      "payments": [
        {
          "value": "",
          "label": "Choose a method",
          "disabled": true
        },
        {
          "value": "card",
          "label": "Card"
        },
        {
          "value": "transfer-tbc",
          "label": "Bank transfer (TBC)"
        },
        {
          "value": "transfer-bog",
          "label": "Bank transfer (Georgian Bank)"
        },
        {
          "value": "crypto",
          "label": "Crypto wallet"
        },
        {
          "value": "apple",
          "label": "Apple Pay"
        }
      ],
      "submit": "Confirm & Pay",
      "download": "Download Excel file"
    },
    "confirm": {
      "missingEvent": "Please select an event to continue.",
      "success": (name, tier, eventTitle) => `${name}, your ${tier} access to ${eventTitle} is locked in.`,
      "excel": "Excel file updated with your booking."
    }
  }
}
const API_BASE = "http://127.0.0.1:5000"; // set to "" if same origin

    const heroEyebrow = document.getElementById('heroEyebrow');
    const heroTitle = document.getElementById('heroTitle');
    const heroIntro = document.getElementById('heroIntro');
    const ctaPrimary = document.getElementById('ctaPrimary');
    const ctaSecondary = document.getElementById('ctaSecondary');
    const statsPanel = document.getElementById('statsPanel');
    const sliderTrack = document.querySelector('.slider-track');
    const sliderDots = document.querySelector('.slider-dots');
    const eventGrid = document.querySelector('.event-grid');
    const timeline = document.querySelector('.timeline');
    const eventSectionEyebrow = document.getElementById('eventSectionEyebrow');
    const eventSectionHeading = document.getElementById('eventSectionHeading');
    const eventSectionCopy = document.getElementById('eventSectionCopy');
    const bookingEyebrow = document.getElementById('bookingEyebrow');
    const eventFocus = document.getElementById('eventFocus');
    const eventCopy = document.getElementById('eventCopy');
    const perksList = document.getElementById('perksList');
    const selectedEventInput = document.getElementById('selectedEvent');
    const nameInput = document.getElementById('nameInput');
    const emailInput = document.getElementById('emailInput');
    const phoneInput = document.getElementById('phoneInput');
    const ticketsInput = document.getElementById('ticketsInput');
    const tierSelect = document.getElementById('tierSelect');
    const paymentSelect = document.getElementById('paymentSelect');
    const paymentIdInput = document.getElementById('paymentIdInput');
    const submitLabel = document.getElementById('submitLabel');
    const confirmation = document.getElementById('confirmation');
    const bookingForm = document.getElementById('bookingForm');
    const profileLink = document.getElementById('profileLink');
    const paymentInfo = document.getElementById('paymentInfo');

    const labelMap = {
      event: document.getElementById('labelEvent'),
      name: document.getElementById('labelName'),
      email: document.getElementById('labelEmail'),
      phone: document.getElementById('labelPhone'),
      guests: document.getElementById('labelGuests'),
      tier: document.getElementById('labelTier'),
      payment: document.getElementById('labelPayment'),
      paymentId: document.getElementById('labelPaymentId')
    };

    let currentLang = 'eng';
    let currentSlides = [];
    let currentEvents = [];
    let sliderIndex = 0;
    let sliderInterval = null;
    let confirmCopy = translations.geo.confirm;
    let cachedUser = null;
    let paymentConfig = null;

    function renderContent(lang) {
      const data = translations[lang];
      currentLang = lang;
      document.documentElement.lang = lang === 'geo' ? 'ka' : 'en';
      confirmCopy = data.confirm;
      heroEyebrow.textContent = data.hero.eyebrow;
      heroTitle.textContent = data.hero.title;
      heroIntro.textContent = data.hero.copy;
      ctaPrimary.textContent = data.hero.primary;
      ctaSecondary.textContent = data.hero.secondary;

      statsPanel.innerHTML = '';
      data.stats.forEach((stat) => {
        const card = document.createElement('div');
        card.className = 'stat';
        card.innerHTML = `<strong>${stat.value}</strong><span>${stat.label}</span>`;
        statsPanel.appendChild(card);
      });

      eventSectionEyebrow.textContent = data.eventSection.eyebrow;
      eventSectionHeading.textContent = data.eventSection.heading;
      eventSectionCopy.textContent = data.eventSection.blurb;

      bookingEyebrow.textContent = data.booking.eyebrow;
      eventFocus.textContent = data.booking.focus;
      eventCopy.textContent = data.booking.copy;
      selectedEventInput.placeholder = data.booking.placeholderEvent;
      nameInput.placeholder = data.booking.namePlaceholder;
      phoneInput.placeholder = data.booking.phonePlaceholder;

      Object.entries(data.form.labels).forEach(([key, value]) => {
        labelMap[key].textContent = value;
      });
      submitLabel.textContent = data.form.submit;

      tierSelect.innerHTML = '';
      data.form.tiers.forEach((tier) => {
        const option = document.createElement('option');
        option.value = tier.value;
        option.textContent = tier.label;
        tierSelect.appendChild(option);
      });

      paymentSelect.innerHTML = '';
      data.form.payments.forEach((method) => {
        const option = document.createElement('option');
        option.value = method.value;
        option.textContent = method.label;
        if (method.disabled) { option.disabled = true; option.selected = true; }
        paymentSelect.appendChild(option);
      });

      perksList.innerHTML = '';
      data.perks.forEach((perk) => {
        const item = document.createElement('li');
        item.textContent = perk;
        perksList.appendChild(item);
      });

      currentSlides = data.slider;
      buildSlider();
      currentEvents = data.events;
      buildEvents();
      if (currentEvents.length) { selectEvent(currentEvents[0], false); }
      updatePaymentInfo();
    }

    function buildSlider() {
      sliderTrack.innerHTML = '';
      sliderDots.innerHTML = '';
      sliderIndex = 0;
      currentSlides.forEach((slide, index) => {
        const article = document.createElement('article');
        article.className = 'slide';
        article.style.background = `linear-gradient(135deg, rgba(0,0,0,.7), ${slide.accent || '#7affc6'})`;
        article.innerHTML = `
          ${slide.image ? `<img src="${slide.image}" alt="Poster for ${slide.title}" class="slide-poster" loading="lazy" />` : ''}
          <div class="slide-content">
            <span class="tag">${slide.tag}</span>
            <h3>${slide.title}</h3>
            <p>${slide.copy}</p>
          </div>
          <div class="slide-footer">
            <span>${slide.meta}</span>
            <span>${currentLang === 'geo' ? 'ჰედლაინერი' : 'Headliner'}</span>
          </div>
        `;
        sliderTrack.appendChild(article);
        const dot = document.createElement('button');
        dot.type = 'button';
        dot.setAttribute('aria-label', 'Show ' + slide.title);
        dot.addEventListener('click', () => goToSlide(index));
        sliderDots.appendChild(dot);
      });
      goToSlide(0);
      if (sliderInterval) clearInterval(sliderInterval);
      if (currentSlides.length > 1) {
        sliderInterval = setInterval(() => { sliderIndex = (sliderIndex + 1) % currentSlides.length; goToSlide(sliderIndex); }, 5200);
      }
    }

    function goToSlide(index) {
      sliderIndex = index;
      sliderTrack.style.transform = `translateX(-${index * 100}%)`;
      document.querySelectorAll('.slider-dots button').forEach((dot, idx) => dot.classList.toggle('active', idx === index));
    }

    function buildEvents() {
      eventGrid.innerHTML = '';
      timeline.innerHTML = '';
      currentEvents.forEach((event) => {
        const card = document.createElement('article');
        card.className = 'event-card';
        if (event.poster) { card.style.backgroundImage = `url('${event.poster}')`; card.style.backgroundSize = 'cover'; card.style.backgroundBlendMode = 'overlay'; }
        const lineupList = (event.lineup || []).map((artist) => `<li>${artist}</li>`).join('');
        const ritualList = (event.rituals || []).map((item) => `<li>${item}</li>`).join('');
        card.innerHTML = `
          <div class="card-body">
            <span class="tag">${event.vibe}</span>
            <h3>${event.title}</h3>
            <p class="event-description">${event.description}</p>
            <div class="event-meta">
              <span>${event.date}</span>
              <span>${event.city}</span>
            </div>
            ${lineupList ? `<p class="micro-label">${currentLang === 'geo' ? 'Line-up' : 'Line-up'}</p><ul class="lineup">${lineupList}</ul>` : ''}
            ${ritualList ? `<p class="micro-label">${currentLang === 'geo' ? 'რას უნდა ელოდოთ' : 'What to expect'}</p><ul class="rituals">${ritualList}</ul>` : ''}
            <div class="event-footer">
              <span class="price">${event.price}</span>
              <button class="mini-cta" type="button">${currentLang === 'geo' ? 'დაჯავშნა' : 'Book'}</button>
            </div>
          </div>
        `;
        card.addEventListener('click', () => selectEvent(event));
        card.querySelector('button').addEventListener('click', (e) => { e.stopPropagation(); selectEvent(event); });
        eventGrid.appendChild(card);
        (event.timeline || []).forEach((nodeData) => {
          const node = document.createElement('article');
          node.className = 'node';
          node.style.borderColor = event.accent;
          node.innerHTML = `<span>${nodeData.label}</span><strong>${nodeData.value}</strong><small>${nodeData.copy || ''}</small>`;
          timeline.appendChild(node);
        });
      });
    }

    function selectEvent(event, scrollToForm = true) {
      selectedEventInput.value = event.title;
      eventFocus.textContent = event.title;
      eventCopy.textContent = event.blurb || `${event.city} | ${event.date}`;
      if (event.accent) document.documentElement.style.setProperty('--electric', event.accent);
      if (scrollToForm) document.getElementById('book').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    const languageButtons = document.querySelectorAll('[data-lang]');
    languageButtons.forEach((button) => {
      button.addEventListener('click', () => {
        languageButtons.forEach((btn) => btn.classList.toggle('active', btn === button));
        renderContent(button.dataset.lang);
      });
    });

    paymentSelect.addEventListener('change', () => {
      const option = paymentSelect.selectedOptions[0];
      if (option && option.disabled) { paymentSelect.value = ''; return; }
      updatePaymentInfo();
    });

    async function fetchCurrentUser() {
      try {
        const res = await fetch(`${API_BASE}/api/user/me`, { credentials: 'include' });
        if (!res.ok) throw new Error('unauthenticated');
        const body = await res.json();
        cachedUser = body.user;
        profileLink.style.display = 'inline-flex';
        profileLink.textContent = (cachedUser && cachedUser.name) ? cachedUser.name : 'Profile';
      } catch (error) {
        cachedUser = null;
        profileLink.style.display = 'none';
      }
      updatePaymentInfo();
    }

    function loadPaymentConfig() {
      if (paymentConfig) return paymentConfig;
      try {
        const stored = localStorage.getItem('fractalPaymentConfig');
        paymentConfig = stored ? JSON.parse(stored) : {};
      } catch (e) { paymentConfig = {}; }
      return paymentConfig;
    }

    function getPaymentId() {
      if (cachedUser && cachedUser.id) return `FR-${cachedUser.id}`;
      if (cachedUser && cachedUser.email) return 'FR-' + btoa(cachedUser.email).replace(/[^A-Z0-9]/gi, '').slice(0, 8);
      return null;
    }

        function updatePaymentInfo() {
      if (!paymentInfo) return;
      const method = paymentSelect.value;
      const cfg = loadPaymentConfig();
      const payId = getPaymentId();
      const descriptionLabel = `Use payment description: "Ticket for ${payId || 'FR-XXXX'}"`;
      const intro = 'Payment instructions';
      const missing = 'Transfer details not set. Please contact admin.';
      paymentInfo.innerHTML = '';
      if (!cachedUser) {
        paymentInfo.innerHTML = 'Please sign in to see payment details and complete booking.';
        return;
      }
      if (method === 'transfer-tbc' || method === 'transfer-bog') {
        const bankLabel = method === 'transfer-tbc' ? 'TBC Bank' : 'Georgian Bank';
        const account = method === 'transfer-tbc' ? cfg.tbcAccount : cfg.bogAccount;
        if (paymentIdInput) paymentIdInput.value = payId || '';
        const details = account ? `
          <h4>${intro} ? ${bankLabel}</h4>
          <p>Send transfer to this account and include in description:</p>
          <div class="payment-steps">
            <div>${descriptionLabel}</div>
            <div>Amount: match your ticket category (I/II/Door)</div>
          </div>
          <p>Account: <strong>${account}</strong></p>
          ${cfg.transferNote ? `<p>${cfg.transferNote}</p>` : ''}
          ${cfg.qrUrl ? `<p>QR code: <a href="${cfg.qrUrl}" target="_blank" style="color:var(--electric);">Open</a></p>` : ''}
        ` : `<p>${missing}</p>`;
        paymentInfo.innerHTML = details;
      } else if (method === 'card') {
        paymentInfo.innerHTML = `<h4>${intro}</h4><p>Pay directly with your card.</p>`;
      } else if (method === 'crypto') {
        paymentInfo.innerHTML = `<h4>${intro}</h4><p>Crypto wallet accepted; include your transfer TX in the booking.</p>`;
      } else if (method === 'apple') {
        paymentInfo.innerHTML = `<h4>${intro}</h4><p>Apple Pay supported.</p>`;
      } else {
        paymentInfo.innerHTML = '';
      }
    }

    bookingForm.addEventListener('submit', async (eventObj) => {
      eventObj.preventDefault();
      confirmation.textContent = '';
      if (!cachedUser) {
        confirmation.textContent = currentLang === 'geo' ? 'დაჯავშნისთვის გთხოვ, შეხვიდე ანგარიშში.' : 'Please sign in to book tickets.';
        return;
      }
      if (!selectedEventInput.value) { confirmation.textContent = confirmCopy.missingEvent; return; }
      const data = new FormData(bookingForm);
      const name = data.get('name') || (currentLang === 'geo' ? 'მეგობარო' : 'Explorer');
      const tier = data.get('tier');
      const payload = {
        language: currentLang,
        event_title: selectedEventInput.value,
        name,
        email: data.get('email'),
        phone: data.get('phone'),
        guests: data.get('tickets'),
        tier,
        payment: data.get('payment'),
        payment_id: data.get('paymentId')
      };
      try {
        const res = await fetch(`${API_BASE}/api/bookings`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const body = await res.json().catch(() => ({}));
        if (!res.ok) throw new Error(body.error || 'Booking failed');
        confirmation.textContent = confirmCopy.success(name, tier, selectedEventInput.value);
        bookingForm.reset();
        if (currentEvents.length) selectEvent(currentEvents[0], false);
      } catch (error) { confirmation.textContent = error.message; }
    });

    document.getElementById('year').textContent = new Date().getFullYear();
    renderContent(currentLang);
    fetchCurrentUser();
  