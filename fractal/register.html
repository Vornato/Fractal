<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fractal Events - Registration</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600&family=Orbitron:wght@500;700&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg:#010b0b;
      --panel:#031818;
      --accent:#7affc6;
      --muted:#8fbbb3;
      --border:rgba(122,255,198,.25);
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:'Space Grotesk',sans-serif;
      background:radial-gradient(circle at top,var(--accent) 0%,transparent 35%),#000607;
      color:#effff9;
      min-height:100vh;
    }
    header{
      padding:1.5rem clamp(1.5rem,4vw,4rem);
      display:flex;
      justify-content:space-between;
      align-items:center;
      position:sticky;
      top:0;
      background:rgba(1,11,11,.9);
      backdrop-filter:blur(18px);
      border-bottom:1px solid var(--border);
      z-index:10;
    }
    header a{
      color:var(--accent);
      text-decoration:none;
      font-weight:600;
      letter-spacing:.08em;
    }
    .user-ops{
      display:flex;
      align-items:center;
      gap:.75rem;
    }
    .user-ops.hidden{display:none;}
    .user-pill{
      padding:.45rem .95rem;
      border:1px solid var(--border);
      border-radius:999px;
      letter-spacing:.06em;
      text-transform:uppercase;
      font-size:.8rem;
      background:rgba(122,255,198,.12);
      color:#7affc6;
    }
    main{
      padding:clamp(1.5rem,4vw,4rem);
      display:grid;
      gap:2rem;
      grid-template-columns:repeat(auto-fit,minmax(300px,1fr));
    }
    .panel{
      background:var(--panel);
      padding:2rem;
      border-radius:1.5rem;
      border:1px solid var(--border);
      box-shadow:0 25px 50px rgba(0,0,0,.4);
    }
    h1,h2{
      font-family:'Orbitron',sans-serif;
      letter-spacing:.12em;
      text-transform:uppercase;
      margin-top:0;
    }
    .muted{color:var(--muted);}
    form{display:flex;flex-direction:column;gap:1rem;}
    label{display:flex;flex-direction:column;font-size:.8rem;letter-spacing:.08em;text-transform:uppercase;color:var(--muted);gap:.4rem;}
    input,select,textarea{
      border:1px solid var(--border);
      border-radius:.8rem;
      background:rgba(0,0,0,.3);
      padding:.85rem 1rem;
      color:#fff;
      font-family:inherit;
    }
    button{
      border:0;
      border-radius:.9rem;
      padding:.95rem 1rem;
      font-weight:600;
      letter-spacing:.08em;
      text-transform:uppercase;
      cursor:pointer;
      background:linear-gradient(120deg,var(--accent),#47c4ff);
      color:#012020;
    }
    .message{min-height:1.5rem;font-size:.9rem;color:var(--accent);}
    .text-button{background:none;border:0;color:var(--accent);cursor:pointer;padding:0;text-decoration:underline;font-size:0.9rem;align-self:flex-start;}
    .text-button:hover{color:#47c4ff;}
    .stack{display:flex;flex-direction:column;gap:1rem;}
    .hidden{display:none;}
    .dashboard{
      grid-column:1/-1;
      background:rgba(3,24,24,.9);
    }
    .profile-grid{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(320px,1fr));
      gap:1.5rem;
      margin-top:1rem;
    }
    .profile-panel{
      background:rgba(0,0,0,.18);
      border:1px solid var(--border);
      border-radius:1.25rem;
      padding:1.25rem;
      box-shadow:0 18px 40px rgba(0,0,0,.35);
    }
    .section-head{display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;margin-bottom:1rem;}
    .section-head h3{margin:0;text-transform:uppercase;letter-spacing:.12em;font-size:1rem;}
    .section-head p{margin:0;color:var(--muted);font-size:.9rem;}
    .event-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:1rem;}
    .event-card{background:rgba(255,255,255,.02);border:1px solid var(--border);border-radius:1rem;padding:1rem;display:flex;flex-direction:column;gap:.65rem;}
    .event-card h4{margin:.2rem 0;font-size:1.05rem;letter-spacing:.06em;}
    .event-meta{display:flex;flex-direction:column;gap:.35rem;color:var(--muted);font-size:.9rem;}
    .pill{display:inline-flex;align-items:center;gap:.35rem;padding:.3rem .8rem;border-radius:999px;border:1px solid var(--border);letter-spacing:.08em;font-size:.78rem;text-transform:uppercase;}
    .buy-btn{margin-top:.3rem;}
    button:disabled, .buy-btn:disabled{opacity:.55;cursor:not-allowed;}
    .ticket-panel{background:rgba(0,0,0,.18);border:1px solid var(--border);border-radius:1.25rem;padding:1.25rem;}
    .ticket-card{border:1px dashed var(--border);border-radius:1rem;padding:1rem;display:flex;flex-direction:column;gap:.6rem;}
    .ticket-links a{color:var(--accent);}
    .status-pill{display:inline-flex;align-items:center;gap:.4rem;padding:.35rem .9rem;border-radius:999px;border:1px solid var(--border);letter-spacing:.1em;}
    .status-pill .icon{width:14px;height:14px;display:inline-flex;align-items:center;justify-content:center;border-radius:4px;font-size:0.7rem;background:rgba(255,255,255,.08);}
    .status-permanent{background:rgba(122,255,198,.18);color:#0fd18a;border-color:rgba(122,255,198,.6);}
    .status-temporary{background:rgba(122,255,198,.08);color:#1be6a1;border:1px dashed rgba(122,255,198,.6);}
    .status-door{background:rgba(255,214,102,.16);color:#ffc861;border-color:rgba(255,214,102,.6);}
    .status-declined{background:rgba(255,122,122,.18);color:#ff7a7a;border-color:rgba(255,122,122,.55);}
    .photo-preview{
      width:120px;
      height:120px;
      border-radius:50%;
      object-fit:cover;
      border:2px solid var(--accent);
    }
    table{
      width:100%;
      border-collapse:collapse;
      margin-top:1rem;
    }
    td,th{padding:.6rem;border-bottom:1px solid rgba(255,255,255,.08);text-align:left;}
    .actions{display:flex;gap:.5rem;flex-wrap:wrap;}
  </style>
</head>
<body>
  <header>
    <span>Fractal Events - Registration</span>
    <nav class="actions">
      <a href="index.html">Home</a>
    </nav>
    <div class="user-ops hidden" id="userOps">
      <span class="user-pill" id="userBadge"></span>
      <button id="logoutBtn" style="margin:0;">Logout</button>
    </div>
  </header>
  <main>
    <section class="panel" id="registerSection">
      <h2>Register</h2>
      <form id="registerForm">
        <label>Full name<input type="text" name="name" required /></label>
        <label>Email<input type="email" name="email" required /></label>
        <label>Password<input type="password" name="password" required minlength="6" /></label>
        <label>Phone<input type="tel" name="phone" required placeholder="+995 5XX XX XX XX" /></label>
        <label>ID number<input type="text" name="idNumber" required /></label>
        <label>Gender<select name="gender" required><option value="">Select</option><option value="female">Female</option><option value="male">Male</option><option value="non-binary">Non-binary</option></select></label>
        <label>Date of birth<input type="date" name="dob" required /></label>
        <label>FB / Instagram link<input type="url" name="social" placeholder="https://instagram.com/username" required /></label>
        <label>City<input type="text" name="city" value="Tbilisi" /></label>
        <button type="submit">Create account</button>
        <p class="message" id="registerMessage"></p>
      </form>
    </section>

    <section class="panel" id="loginSection">
      <h2>Login</h2>
      <form id="loginForm">
        <label>Email<input type="email" name="email" required /></label>
        <label>Password<input type="password" name="password" required /></label>
        <button type="submit">Log in</button>
        <p class="message" id="loginMessage"></p>
      </form>
      <button type="button" class="text-button" id="forgotToggle">Forgot password?</button>
      <form id="forgotForm" class="hidden">
        <label>Email<input type="email" name="email" required /></label>
        <button type="submit">Send reset link</button>
        <p class="message" id="forgotMessage"></p>
      </form>
      <form id="resetForm" class="hidden">
        <label>New password<input type="password" name="password" required minlength="6" /></label>
        <label>Repeat password<input type="password" name="confirm" required minlength="6" /></label>
        <input type="hidden" name="token" />
        <button type="submit">Set new password</button>
        <p class="message" id="resetMessage"></p>
      </form>
    </section>

    <section class="panel dashboard hidden" id="userDashboard">
      <h2>Your profile</h2>
      <div class="profile-grid">
        <div class="profile-panel">
          <div id="approvalPill" class="status-pill">Status: pending</div>
          <div class="stack" style="margin-top:1rem;">
            <img id="profilePhoto" class="photo-preview" src="" alt="Profile" />
            <strong id="userName"></strong>
            <p id="userEmail"></p>
            <p id="userDetails"></p>
          </div>
          <form id="photoForm" style="margin-top:1rem;">
            <label>Profile photo (JPG/PNG)
              <input type="file" name="photo" accept="image/*" />
            </label>
            <button type="submit">Upload photo</button>
            <p class="message" id="photoMessage"></p>
          </form>
        </div>
        <div class="profile-panel">
          <div class="section-head">
            <h3>Upcoming events</h3>
            <p class="muted">Select and jump to booking. Available if your status is permanent or temporary.</p>
          </div>
          <div class="event-grid" id="profileEvents"></div>
        </div>
        <div class="profile-panel">
          <div class="section-head">
            <h3>Your tickets</h3>
            <p class="muted">If admin assigns QR / ticket links, they appear here.</p>
          </div>
          <div id="userTickets" class="ticket-panel">
            <p class="muted">No tickets yet.</p>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const API_BASE = "https://fractal-ns5x.onrender.com"; // production backend

    const registerForm = document.getElementById('registerForm');
    const loginForm = document.getElementById('loginForm');
    const registerSection = document.getElementById('registerSection');
    const loginSection = document.getElementById('loginSection');
    const forgotForm = document.getElementById('forgotForm');
    const resetForm = document.getElementById('resetForm');
    const forgotToggle = document.getElementById('forgotToggle');
    const resetMessage = document.getElementById('resetMessage');
    const forgotMessage = document.getElementById('forgotMessage');
    const registerMessage = document.getElementById('registerMessage');
    const loginMessage = document.getElementById('loginMessage');
    const dashboard = document.getElementById('userDashboard');
    const approvalPill = document.getElementById('approvalPill');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const userDetails = document.getElementById('userDetails');
    const profilePhoto = document.getElementById('profilePhoto');
    const photoForm = document.getElementById('photoForm');
    const photoMessage = document.getElementById('photoMessage');
    const userOps = document.getElementById('userOps');
    const userBadge = document.getElementById('userBadge');
    const logoutBtn = document.getElementById('logoutBtn');
    const profileEvents = document.getElementById('profileEvents');
    const userTickets = document.getElementById('userTickets');
    const ADMIN_EMAIL = 'FractalAdmin@123';

    const upcomingEvents = [
      {
        title: 'ANIMATO - NEXT CHAPTER TBILISI',
        date: '28 November 2024 | Friday',
        venue: 'Tsameti Restaurant, 13e Mikheil Tamarashvili St, Tbilisi',
        price: '60/80/120 â‚¾',
        tag: 'Headliner',
        blurb: 'Animato, SHALA, and Georgian selectors deliver lasers, UV art, and heavy bass for a nonstop night.'
      }
    ];

    function loadPaymentConfig() {
      try {
        const stored = localStorage.getItem('fractalPaymentConfig');
        return stored ? JSON.parse(stored) : {};
      } catch (e) { return {}; }
    }

    function loadTicketData() {
      try {
        const stored = localStorage.getItem('fractalTickets');
        return stored ? JSON.parse(stored) : {};
      } catch (e) { return {}; }
    }

    function saveTicketData(data) {
      localStorage.setItem('fractalTickets', JSON.stringify(data));
    }

    const defaultPhoto = 'https://images.unsplash.com/photo-1524504388940-b1c1722653e1?auto=format&w=240&q=60';
    function renderStatusPill(status) {
      const normalized = (status || '').toLowerCase();
      const meta = {
        permanent: { text: 'Permanent', icon: '&#10003;', cls: 'status-permanent' }, // filled check
        temporary: { text: 'Temporary', icon: '&#9744;', cls: 'status-temporary' }, // empty checkbox
        door: { text: 'Door', icon: '&#9633;', cls: 'status-door' }, // yellow square
        declined: { text: 'Declined', icon: '&#10007;', cls: 'status-declined' } // red X
      }[normalized] || { text: status || 'Pending', icon: '?', cls: '' };
      return `<span class="status-pill ${meta.cls}"><span class="icon">${meta.icon}</span>Status: ${meta.text}</span>`;
    }

    function updateAuthVisibility(user) {
      const isAdmin = user && user.email === ADMIN_EMAIL;
      const hideAuth = !!user && !isAdmin;
      registerSection.classList.toggle('hidden', hideAuth);
      loginSection.classList.toggle('hidden', hideAuth);
      if (hideAuth) {
        toggleForgot(false);
        toggleReset(false);
      }
    }

    function toggleForgot(show) {
      forgotForm.classList.toggle('hidden', !show);
    }

    function toggleReset(show) {
      resetForm.classList.toggle('hidden', !show);
    }

    function showResetWithToken(token) {
      toggleForgot(false);
      toggleReset(true);
      resetForm.querySelector('input[name="token"]').value = token;
      resetMessage.textContent = 'Enter a new password for your account.';
      resetMessage.style.color = '#7affc6';
    }

    const state = {
      user: null
    };

    function showMessage(el, text, isError = false) {
      el.textContent = text;
      el.style.color = isError ? '#ff8080' : '#7affc6';
    }

    async function api(path, { method = 'GET', body, headers } = {}) {
      const opts = {
        method,
        credentials: 'include',
        headers: headers || {}
      };
      if (body instanceof FormData) {
        opts.body = body;
      } else if (body) {
        opts.headers['Content-Type'] = 'application/json';
        opts.body = JSON.stringify(body);
      }
      const res = await fetch(`${API_BASE}${path}`, opts);
      let data = null;
      try {
        data = await res.json();
      } catch (e) {
        /* ignore */
      }
      if (!res.ok) {
        const error = (data && data.error) || `Request failed (${res.status})`;
        throw new Error(error);
      }
      return data;
    }

    function renderDashboard(user) {
      if (!user) {
        dashboard.classList.add('hidden');
        userOps.classList.add('hidden');
        profileEvents.innerHTML = '';
        updateAuthVisibility(null);
        return;
      }
      dashboard.classList.remove('hidden');
      const status = user.status || 'pending';
      const isApproved = status === 'permanent' || status === 'temporary' || status === 'door';
      approvalPill.innerHTML = renderStatusPill(status);
      const photoUrl = user.profile_photo_path ? `${API_BASE}/uploads/${user.profile_photo_path}` : defaultPhoto;
      profilePhoto.src = photoUrl;
      userName.textContent = user.name || '';
      userEmail.textContent = user.email || '';
      const dob = user.dob ? user.dob : 'N/A';
      userDetails.textContent = `ID: ${user.id_number || 'N/A'} | ${user.gender || '-'} | DOB: ${dob} | Phone: ${user.phone || '-'}`;
      userBadge.textContent = user.name || user.email || 'Profile';
      userOps.classList.remove('hidden');
      renderEventsForUser(user);
      renderTicketsForUser(user);
      updateAuthVisibility(user);
    }

    function canPurchase(user) {
      return user && (user.status === 'permanent' || user.status === 'temporary');
    }

    function renderEventsForUser(user) {
      profileEvents.innerHTML = '';
      const allowed = canPurchase(user);
      upcomingEvents.forEach((evt) => {
        const card = document.createElement('article');
        card.className = 'event-card';
        card.innerHTML = `
          <div class="pill">${evt.tag}</div>
          <h4>${evt.title}</h4>
          <div class="event-meta">
            <span>${evt.date}</span>
            <span>${evt.venue}</span>
            <span>Price: ${evt.price}</span>
          </div>
          <p>${evt.blurb}</p>
        `;
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'buy-btn';
        btn.textContent = allowed ? 'Buy ticket' : 'Status required';
        btn.disabled = !allowed;
        btn.addEventListener('click', () => { window.location.href = 'index.html#book'; });
        card.appendChild(btn);
        profileEvents.appendChild(card);
      });
    }

    function renderTicketsForUser(user) {
      userTickets.innerHTML = '';
      const data = loadTicketData();
      const key = user && (user.id || user.email);
      const ticket = key ? data[key] : null;
      if (!ticket) {
        userTickets.innerHTML = '<p class="muted">No tickets assigned yet.</p>';
        return;
      }
      const card = document.createElement('div');
      card.className = 'ticket-card';
      card.innerHTML = `
        <div><strong>Ticket for ${ticket.paymentId || key}</strong></div>
        ${ticket.qr ? `<div class="ticket-links">QR: <a href="${ticket.qr}" target="_blank">Open</a></div>` : ''}
        ${ticket.ticket ? `<div class="ticket-links">Ticket: <a href="${ticket.ticket}" target="_blank">Download</a></div>` : ''}
        ${ticket.note ? `<p class="muted">${ticket.note}</p>` : ''}
      `;
      userTickets.appendChild(card);
    }

    async function fetchCurrentUser() {
      try {
        const data = await api('/api/user/me');
        state.user = data.user;
        renderDashboard(state.user);
      } catch (error) {
        state.user = null;
        renderDashboard(null);
      }
    }

    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      registerMessage.textContent = '';
      const data = new FormData(registerForm);
      const payload = {
        name: data.get('name'),
        email: data.get('email'),
        password: data.get('password'),
        phone: data.get('phone'),
        id_number: data.get('idNumber'),
        gender: data.get('gender'),
        dob: data.get('dob'),
        social_link: data.get('social'),
        city: data.get('city') || 'Tbilisi'
      };
      try {
        await api('/api/auth/register', { method: 'POST', body: payload });
        // Auto-login right after successful registration
        const loginRes = await api('/api/auth/login', { method: 'POST', body: { email: payload.email, password: payload.password } });
        state.user = loginRes.user;
        registerForm.reset();
        if (payload.email === 'FractalAdmin@123' && payload.password === 'Fractalisadmin123') {
          window.location.href = 'admin.html';
          return;
        }
        renderDashboard(state.user);
        showMessage(registerMessage, 'Registration successful. You are logged in.');
      } catch (error) {
        showMessage(registerMessage, error.message, true);
      }
    });

    forgotToggle.addEventListener('click', () => {
      toggleForgot(true);
      toggleReset(false);
      forgotMessage.textContent = 'Enter your email to receive a reset link.';
      forgotMessage.style.color = '#7affc6';
    });

    forgotForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      forgotMessage.textContent = '';
      forgotMessage.style.color = '#7affc6';
      const data = new FormData(forgotForm);
      const email = data.get('email');
      try {
        const res = await api('/api/auth/forgot-password', { method: 'POST', body: { email } });
        forgotMessage.textContent = res.message || 'If that email exists, a reset link was sent.';
        if (res.reset_link) {
          forgotMessage.textContent += ' (Link generated for testing.)';
        }
      } catch (error) {
        forgotMessage.textContent = error.message || 'Could not send reset link.';
        forgotMessage.style.color = '#ff8080';
      }
    });

    resetForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      resetMessage.textContent = '';
      const data = new FormData(resetForm);
      const password = data.get('password');
      const confirm = data.get('confirm');
      const token = data.get('token');
      if (password !== confirm) {
        resetMessage.textContent = 'Passwords do not match.';
        resetMessage.style.color = '#ff8080';
        return;
      }
      try {
        const res = await api('/api/auth/reset-password', { method: 'POST', body: { token, password } });
        resetMessage.textContent = res.message || 'Password reset. You can now log in.';
        resetMessage.style.color = '#7affc6';
        toggleReset(false);
      } catch (error) {
        resetMessage.textContent = error.message || 'Could not reset password.';
        resetMessage.style.color = '#ff8080';
      }
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginMessage.textContent = '';
      const data = new FormData(loginForm);
      const email = data.get('email');
      const password = data.get('password');
      const payload = {
        email,
        password
      };
      try {
        const res = await api('/api/auth/login', { method: 'POST', body: payload });
        state.user = res.user;
        loginForm.reset();
        if (email === 'FractalAdmin@123' && password === 'Fractalisadmin123') {
          window.location.href = 'admin.html';
          return;
        }
        showMessage(loginMessage, 'Logged in.');
        renderDashboard(state.user);
      } catch (error) {
        showMessage(loginMessage, error.message, true);
      }
    });

    photoForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!state.user) return;
      const file = photoForm.photo.files[0];
      if (!file) {
        showMessage(photoMessage, 'No file selected.', true);
        return;
      }
      const form = new FormData();
      form.append('photo', file);
      try {
        const res = await api('/api/user/photo', { method: 'POST', body: form });
        state.user.profile_photo_path = res.photo;
        showMessage(photoMessage, 'Photo updated.');
        renderDashboard(state.user);
        photoForm.reset();
      } catch (error) {
        showMessage(photoMessage, error.message, true);
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try {
        await api('/api/auth/logout', { method: 'POST' });
      } catch (error) {
        /* ignore logout errors */
      } finally {
        state.user = null;
        renderDashboard(null);
        userOps.classList.add('hidden');
      }
    });

    (function handleResetHash() {
      if (window.location.hash && window.location.hash.startsWith('#reset=')) {
        const token = window.location.hash.replace('#reset=', '');
        if (token) {
          showResetWithToken(token);
        }
      }
    })();

    fetchCurrentUser();
  </script>
</body>
</html>
